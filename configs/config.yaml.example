# Storj Synthetics Monitoring - Configuration Example
# All tests use unified structure with sequential steps

satellite:
  # Access grant for native Uplink tests - use environment variable for security
  # Generate at: https://www.storj.io/
  access_grant: "${STORJ_ACCESS_GRANT}"

  # Default bucket name for tests
  bucket: "synthetics-test"

s3:
  # S3 Gateway configuration for S3-compatible tests
  # Leave empty to disable S3 executor
  endpoint: "${S3_ENDPOINT:-https://gateway.storjshare.io}"
  access_key: "${S3_ACCESS_KEY}"
  secret_key: "${S3_SECRET_KEY}"
  region: "us-east-1"

k6:
  # Path to k6 binary (custom xk6 build)
  binary_path: "/usr/local/bin/k6"

  # Output format for k6 results
  output_format: "json"

metrics:
  # HTTP server port for Prometheus metrics
  port: 8080

  # Metrics endpoint path
  path: "/metrics"

logging:
  # Log level: debug, info, warn, error
  level: "info"

  # Log format: json, text
  format: "json"

# ============================================================================
# Jitter Configuration (prevents thundering herd)
# ============================================================================
# Jitter adds a random delay before test/step execution to spread load.
# Disabled by default. Can be overridden at test and step levels.
#
# Format options:
#   - Duration: "30s", "1m", "2m30s" (fixed maximum jitter)
#   - Percentage: "10%" (percentage of cron schedule interval)
#
# Inheritance: step -> test -> global (most specific wins)
jitter:
  enabled: false  # Global default: no jitter
  max: "30s"      # Maximum jitter when enabled

# ============================================================================
# Tests - Unified Structure
# ============================================================================
# All tests have 1+ sequential steps. Each test run gets a unique ULID-based
# filename by default, or you can specify a custom filename.
#
# Executor types:
# - "uplink": Tests native Storj protocol via k6 + xk6-storj extension (default)
# - "s3": Tests S3-compatible gateway via AWS SDK v2 (pure Go, no k6)
# - "http-s3": Tests S3 gateway via raw HTTP requests (Go net/http, no AWS SDK)
# - "curl-s3": Tests S3 gateway via curl subprocess (shells out to curl)
#
# Filename behavior:
# - No 'filename' field: Auto-generated as {test-name}-{ULID}.bin (default)
# - With 'filename' field: Uses custom filename for all runs
#
# Bucket override:
# - No 'bucket' field: Uses global bucket from satellite.bucket
# - With 'bucket' field: Uses test-specific bucket

tests:
  # ============================================================================
  # Example 1: Uplink workflow (native Storj protocol via k6)
  # ============================================================================
  # Basic upload → download → delete workflow every 5 minutes
  - name: "uplink-workflow"
    schedule: "*/5 * * * *"  # Every 5 minutes
    enabled: true
    executor: "uplink"  # k6 + xk6-storj extension (default, can be omitted)
    # No filename = ULID-based: uplink-workflow-01HQZX4VWXY7Z8A9B0C1D2E3F4.bin
    steps:
      - name: "upload"
        script: "/app/scripts/tests/upload.js"
        timeout: "1m"
        file_size: "512KB"  # Human-readable (also accepts 524288)

      - name: "download"
        script: "/app/scripts/tests/download.js"
        timeout: "30s"

      - name: "delete"
        script: "/app/scripts/tests/delete.js"
        timeout: "30s"

  # ============================================================================
  # Example 2: S3 workflow (S3-compatible gateway via AWS SDK)
  # ============================================================================
  # Same workflow but via S3 protocol - no JavaScript scripts needed!
  - name: "s3-workflow"
    schedule: "*/5 * * * *"  # Every 5 minutes
    enabled: false  # Enable when S3 credentials are configured
    executor: "s3"  # Pure Go with AWS SDK
    steps:
      - name: "upload"
        timeout: "1m"
        file_size: "512KB"  # Supports: B, KB, MB, GB
        ttl_seconds: 3600   # TTL also supported on S3!

      - name: "download"
        timeout: "30s"

      - name: "delete"
        timeout: "30s"

  # ============================================================================
  # Example 2b: HTTP S3 workflow (raw HTTP, no AWS SDK)
  # ============================================================================
  # Uses Go's net/http with manual AWS Signature V4 signing
  # Useful for debugging or when you want minimal dependencies
  - name: "http-s3-workflow"
    schedule: "*/5 * * * *"
    enabled: false
    executor: "http-s3"  # Raw HTTP requests, no AWS SDK
    steps:
      - name: "upload"
        timeout: "1m"
        file_size: "512KB"

      - name: "download"
        timeout: "30s"

      - name: "delete"
        timeout: "30s"

  # ============================================================================
  # Example 2c: Curl S3 workflow (shells out to curl)
  # ============================================================================
  # Uses curl subprocess for S3 operations
  # Useful for debugging HTTP-level issues or testing curl behavior
  - name: "curl-s3-workflow"
    schedule: "*/5 * * * *"
    enabled: false
    executor: "curl-s3"  # Uses curl subprocess
    steps:
      - name: "upload"
        timeout: "1m"
        file_size: "512KB"

      - name: "download"
        timeout: "30s"

      - name: "delete"
        timeout: "30s"

  # ============================================================================
  # Example 3: Large file workflow with bucket override
  # ============================================================================
  # Test performance with large files hourly in a separate bucket
  - name: "large-file-test"
    schedule: "0 * * * *"  # Every hour at :00
    enabled: false
    bucket: "large-files-test"  # Override global bucket
    steps:
      - name: "upload"
        script: "/app/scripts/tests/upload.js"
        timeout: "5m"
        file_size: "10MB"  # Human-readable format

      - name: "download"
        script: "/app/scripts/tests/download.js"
        timeout: "2m"

      - name: "verify-again"
        script: "/app/scripts/tests/download.js"
        timeout: "2m"

      - name: "delete"
        script: "/app/scripts/tests/delete.js"
        timeout: "1m"

  # ============================================================================
  # Example 4: Canary file with custom filename
  # ============================================================================
  # Upload a persistent canary file daily
  - name: "canary-upload"
    schedule: "0 0 * * *"  # Midnight daily
    enabled: false
    filename: "canary-file.bin"  # Custom filename - same across all runs
    steps:
      - name: "upload"
        script: "/app/scripts/tests/upload.js"
        timeout: "2m"
        file_size: "1MB"

  # Check canary file every 5 minutes
  - name: "canary-check"
    schedule: "*/5 * * * *"  # Every 5 minutes
    enabled: false
    filename: "canary-file.bin"  # Same custom filename
    steps:
      - name: "download"
        script: "/app/scripts/tests/download.js"
        timeout: "1m"

  # Delete canary file monthly
  - name: "canary-cleanup"
    schedule: "0 0 1 * *"  # 1st of each month
    enabled: false
    filename: "canary-file.bin"  # Same custom filename
    steps:
      - name: "delete"
        script: "/app/scripts/tests/delete.js"
        timeout: "1m"

  # ============================================================================
  # Example 5: Single-step upload test (ULID-based filename)
  # ============================================================================
  - name: "standalone-upload"
    schedule: "*/2 * * * *"  # Every 2 minutes
    enabled: false
    steps:
      - name: "upload"
        script: "/app/scripts/tests/upload.js"
        timeout: "1m"
        file_size: "1MB"

  # ============================================================================
  # Example 6: Upload with TTL (auto-expiring files)
  # ============================================================================
  # Upload files that automatically expire after TTL period
  - name: "ttl-upload"
    schedule: "*/10 * * * *"  # Every 10 minutes
    enabled: false
    steps:
      - name: "upload"
        script: "/app/scripts/tests/upload.js"
        timeout: "1m"
        file_size: "512KB"
        ttl_seconds: 3600    # Expires in 1 hour
        # TTL examples: 300 (5min), 3600 (1hr), 86400 (1day), 604800 (1week)

  # ============================================================================
  # Example 7: Single-step download test (finds files by prefix)
  # ============================================================================
  - name: "download-random"
    schedule: "*/3 * * * *"  # Every 3 minutes
    enabled: false
    steps:
      - name: "download"
        script: "/app/scripts/tests/download.js"
        timeout: "1m"
        file_prefix: "synthetics"  # Downloads random file matching prefix

  # ============================================================================
  # Example 8: Cleanup old files hourly
  # ============================================================================
  - name: "cleanup-old-files"
    schedule: "0 * * * *"  # Every hour at :00
    enabled: false
    steps:
      - name: "cleanup"
        script: "/app/scripts/tests/delete.js"
        timeout: "2m"
        max_age_minutes: 60   # Delete files older than 60 minutes
        max_delete: 10        # Max files to delete per run
        file_prefix: "synthetics"  # Only delete files with this prefix

  # ============================================================================
  # Example 9: List objects test
  # ============================================================================
  - name: "list-objects"
    schedule: "*/15 * * * *"  # Every 15 minutes
    enabled: false
    steps:
      - name: "list"
        script: "/app/scripts/tests/list_objects.js"
        timeout: "1m"

  # ============================================================================
  # Example 10: Multi-size performance testing
  # ============================================================================
  # Small files - high frequency
  - name: "small-file-test"
    schedule: "*/2 * * * *"  # Every 2 minutes
    enabled: false
    steps:
      - name: "upload"
        script: "/app/scripts/tests/upload.js"
        timeout: "1m"
        file_size: "100KB"
      - name: "download"
        script: "/app/scripts/tests/download.js"
        timeout: "30s"
      - name: "delete"
        script: "/app/scripts/tests/delete.js"
        timeout: "30s"

  # Medium files - moderate frequency
  - name: "medium-file-test"
    schedule: "*/10 * * * *"  # Every 10 minutes
    enabled: false
    steps:
      - name: "upload"
        script: "/app/scripts/tests/upload.js"
        timeout: "5m"
        file_size: "10MB"
      - name: "download"
        script: "/app/scripts/tests/download.js"
        timeout: "2m"
      - name: "delete"
        script: "/app/scripts/tests/delete.js"
        timeout: "1m"

  # Large files - low frequency
  - name: "huge-file-test"
    schedule: "0 */2 * * *"  # Every 2 hours
    enabled: false
    steps:
      - name: "upload"
        script: "/app/scripts/tests/upload.js"
        timeout: "15m"
        file_size: "100MB"
      - name: "download"
        script: "/app/scripts/tests/download.js"
        timeout: "10m"
      - name: "delete"
        script: "/app/scripts/tests/delete.js"
        timeout: "2m"

  # ============================================================================
  # Example 11: Business hours intensive testing
  # ============================================================================
  - name: "business-hours-workflow"
    schedule: "*/5 9-17 * * 1-5"  # Every 5 min, Mon-Fri, 9am-5pm
    enabled: false
    steps:
      - name: "upload"
        script: "/app/scripts/tests/upload.js"
        timeout: "2m"
        file_size: "2MB"
      - name: "download"
        script: "/app/scripts/tests/download.js"
        timeout: "1m"
      - name: "list"
        script: "/app/scripts/tests/list_objects.js"
        timeout: "1m"
      - name: "delete"
        script: "/app/scripts/tests/delete.js"
        timeout: "1m"

  # ============================================================================
  # Example 12: Test with jitter (prevents thundering herd)
  # ============================================================================
  # When multiple tests run on the same schedule, jitter spreads the load
  - name: "jitter-workflow"
    schedule: "*/5 * * * *"  # Every 5 minutes
    enabled: false
    executor: "s3"
    jitter:
      enabled: true
      max: "10%"  # 10% of 5 minutes = up to 30 seconds random delay
    steps:
      - name: "upload"
        timeout: "1m"
        file_size: "512KB"
        # Step can override test-level jitter
        jitter:
          enabled: true
          max: "5s"  # Fixed 0-5 second delay before upload

      - name: "download"
        timeout: "30s"
        # Inherits test-level jitter (10% = 30s max)

      - name: "delete"
        timeout: "30s"
        # Disable jitter for delete step only
        jitter:
          enabled: false

# ============================================================================
# Test Data Files
# ============================================================================
# Test data files are pre-generated on container startup and cached in
# /tmp/test-data/ with the naming pattern: {test-name}-{size}.bin
#
# This means:
# - First test run: Uses cached file from disk (fast)
# - Subsequent runs: Continues using same cached file
# - No CPU overhead generating random data each time
# - Consistent data enables integrity verification
#
# Pre-generated files:
# - quick-workflow-524288.bin (512KB)
# - test-data-1048576.bin (1MB)
# - large-file-test-10485760.bin (10MB)

# ============================================================================
# Test Configuration Fields
# ============================================================================
# Test-level fields:
#   name: Test name (required)
#   schedule: Cron expression (required)
#   enabled: true/false (required)
#   executor: "uplink", "s3", "http-s3", or "curl-s3" (default: "uplink")
#   bucket: Override global bucket (optional)
#   filename: Custom filename for all runs (optional)
#   jitter: Jitter configuration (optional, overrides global)
#     enabled: true/false
#     max: Duration ("30s") or percentage of interval ("10%")
#   steps: Array of test steps (required, 1+)
#
# Step configuration fields:
#
# Common fields (all executors):
#   name: Step name (e.g., "upload", "download", "delete")
#   timeout: Max execution time (e.g., "1m", "30s")
#
# Uplink executor (requires script field):
#   script: Path to k6 test script (required for uplink)
#
# S3-based executors (s3, http-s3, curl-s3 - no script needed):
#   Operations determined by step name: upload, download, delete
#   All use the same S3 credentials from the s3: config section
#
# Upload-specific fields:
#   file_size: Human-readable (e.g., "512KB", "5MB", "1GB") or bytes
#   ttl_seconds: Time-to-live in seconds (optional, uplink only)
#     Examples: 300 (5min), 3600 (1hr), 86400 (1day)
#
# Download-specific fields (uplink only):
#   file_prefix: File prefix filter (optional)
#
# Delete-specific fields (uplink only):
#   file_prefix: File prefix filter (optional)
#   max_age_minutes: Delete files older than N minutes (optional)
#   max_delete: Max number of files to delete (optional)
#
# Jitter fields (all executors):
#   jitter: Step-level jitter configuration (optional, overrides test-level)
#     enabled: true/false
#     max: Duration ("5s", "30s") - percentage not supported at step level
#
# Environment variables (automatically set for uplink executor):
#   TEST_NAME: The test name
#   TEST_ULID: Unique ULID for this test run
#   SHARED_FILE: Filename for this test run
#   STORJ_ACCESS_GRANT: Storj access grant
#   STORJ_BUCKET: Bucket name

# ============================================================================
# Metrics
# ============================================================================
# Exposed at /metrics endpoint for Prometheus scraping:
#
# - synthetics_test_runs_total{test_name, status}
#     - Single-step: test_name="standalone-upload"
#     - Multi-step: test_name="quick-workflow" (overall)
#                   test_name="quick-workflow.upload" (individual step)
#
# - storj_upload_duration_seconds{test_name, bucket}
# - storj_download_duration_seconds{test_name, bucket}
# - storj_upload_bytes_total{test_name, bucket}
# - storj_download_bytes_total{test_name, bucket}
# - storj_delete_count_total{test_name, bucket}

# ============================================================================
# Cron Schedule Format
# ============================================================================
# Standard cron format: minute hour day month weekday
#
# Examples:
#   "*/5 * * * *"       - Every 5 minutes
#   "0 * * * *"         - Every hour at :00
#   "0 0 * * *"         - Daily at midnight
#   "0 0 * * 0"         - Weekly on Sunday at midnight
#   "0 0 1 * *"         - Monthly on the 1st at midnight
#   "*/5 9-17 * * 1-5"  - Every 5 min, Mon-Fri, 9am-5pm
#
# Use https://crontab.guru/ to validate your cron expressions
